{% extends 'dashboard/dashboard_base.html' %}
{% load static %}

{% block title %}RÃ©servations{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
    href="{% static 'css/gareci_admin/reservation_list.css' %}">
{% endblock %}

{% block content %}
<!-- EN-TÃŠTE DE PAGE -->
<div class="page-header">
  <h1>ğŸ“‹ RÃ©servations par date de voyage</h1>
  <span class="total-badge">
    {{ dates|length }} date(s) â€¢
    {% with total=0 %}
      {{ dates|length }} groupe(s)
    {% endwith %}
  </span>
</div>

<!-- SI AUCUNE RÃ‰SERVATION -->
{% if not dates %}
<div class="empty-state">
  <p>ğŸ« Aucune rÃ©servation en cours.</p>
</div>

{% else %}

<!-- ACCORDÃ‰ONS -->
{% for item in dates|dictsortreversed:'date' %}
<div class="accordion-item"
   id="accordion-{{ item.date|date:'Y-m-d' }}">

  <!-- â•â•â• EN-TÃŠTE DE L'ACCORDÃ‰ON â•â•â• -->
  <div class="accordion-header"
     onclick="toggleAccordion('{{ item.date|date:'Y-m-d' }}')">

    <!-- Date -->
    <div class="accordion-left">
      <span class="accordion-icon">ğŸ“…</span>
      <span class="accordion-date">
        {{ item.date|date:"l d F Y" }}
      </span>
      <span class="accordion-count">
        ({{ item.nb_total }} rÃ©servation(s))
      </span>
    </div>

    <!-- Badges de statistiques -->
    <div class="accordion-badges">
      {% if item.nb_confirmees %}
      <span class="badge badge-vert">
        âœ… {{ item.nb_confirmees }} confirmÃ©e(s)
      </span>
      {% endif %}

      {% if item.nb_en_attente %}
      <span class="badge badge-orange">
        â³ {{ item.nb_en_attente }} en attente
      </span>
      {% endif %}

      {% if item.recettes %}
      <span class="badge badge-bleu">
        ğŸ’° {{ item.recettes }} FCFA
      </span>
      {% endif %}
    </div>

    <!-- FlÃ¨che -->
    <span class="accordion-arrow"
        id="arrow-{{ item.date|date:'Y-m-d' }}">
      â–¼
    </span>
  </div>

  <!-- â•â•â• CORPS DE L'ACCORDÃ‰ON â•â•â• -->
  <div class="accordion-body"
     id="body-{{ item.date|date:'Y-m-d' }}">

    <table class="table-reservations">
      <thead>
        <tr>
          <th>RÃ©fÃ©rence</th>
          <th>Client</th>
          <th>Trajet</th>
          <th>Heure dÃ©part</th>
          <th>Heure arrivÃ©e</th>
          <th>Places</th>
          <th>Total</th>
          <th>Statut</th>
          
        </tr>
      </thead>
      <tbody>
        {% for resa in item.reservations %}
        <tr>
          <!-- RÃ©fÃ©rence -->
          <td>
            <code class="reference">
              {{ resa.reference }}
            </code>
          </td>

          <!-- Client -->
          <td>
            <span class="client-nom">
              {{ resa.utilisateur.get_full_name|default:resa.utilisateur.username }}
            </span>
            <br>
            <small class="client-tel">
              {{ resa.utilisateur.phone|default:"â€”" }}
            </small>
          </td>

          <!-- Trajet -->
          <td>
            {{ resa.depart.trip.arret_depart.ville }}
            <span class="fleche">â†’</span>
            {{ resa.depart.trip.arret_arrivee.ville }}
          </td>

          <!-- Heure dÃ©part -->
          <td>
            {{ resa.depart.heure_depart|time:"H:i" }}
          </td>

          <!-- Heure arrivÃ©e -->
          <td>
            {{ resa.depart.heure_arrivee|time:"H:i" }}
          </td>

          <!-- Places -->
          <td>{{ resa.nombre_places }}</td>

          <!-- Total -->
          <td>{{ resa.prix_total }} FCFA</td>

          <!-- Statut -->
          <td>
            {% if resa.statut == 'CONFIRMEE' %}
              <span class="badge badge-vert">
                âœ… ConfirmÃ©e
              </span>
            {% elif resa.statut == 'EN_ATTENTE' %}
              <span class="badge badge-orange">
                â³ En attente
              </span>
            {% endif %}
          </td>

          
        </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>
{% endfor %}

{% endif %}

{% endblock %}

{% block extra_js %}
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GESTION DES ACCORDÃ‰ONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

function toggleAccordion(dateId) {
  const body  = document.getElementById('body-'  + dateId);
  const arrow = document.getElementById('arrow-' + dateId);

  if (!body || !arrow) return;

  const isOpen = body.style.display === 'block';
  body.style.display = isOpen ? 'none' : 'block';
  arrow.textContent  = isOpen ? 'â–¼' : 'â–²';
}

/* Ouvrir automatiquement l'accordÃ©on de la date du jour */
document.addEventListener('DOMContentLoaded', function () {
  const today = new Date().toISOString().split('T')[0];
  const bodyDuJour  = document.getElementById('body-'  + today);
  const arrowDuJour = document.getElementById('arrow-' + today);

  if (bodyDuJour) {
    bodyDuJour.style.display = 'block';
    arrowDuJour.textContent  = 'â–²';
  }
});
</script>
{% endblock %}
