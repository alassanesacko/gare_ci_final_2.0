{% extends 'dashboard/dashboard_base.html' %}
{% block title %}ğŸ“‹ RÃ©servations par date de voyage{% endblock %}
{% block content %}
<!-- ACCORDÃ‰ON PAR DATE DE VOYAGE -->
{% for item in dates %}
<div class="accordion-item" id="date-{{ item.date|date:'Y-m-d' }}">
  <div class="accordion-header" onclick="toggleAccordion('date-{{ item.date|date:'Y-m-d' }}')">
    <div class="accordion-left">
      <span class="accordion-icon">ğŸ“…</span>
      <span class="accordion-date">{{ item.date|date:"l d F Y" }}</span>
    </div>
    <div class="accordion-badges">
      {% if item.nb_confirmees %}
      <span class="badge badge-vert">âœ… {{ item.nb_confirmees }} confirmÃ©e(s)</span>
      {% endif %}
      {% if item.nb_en_attente %}
      <span class="badge badge-orange">â³ {{ item.nb_en_attente }} en attente</span>
      {% endif %}
      <span class="badge badge-gris">ğŸ’° {{ item.recettes }} FCFA</span>
    </div>
    <span class="accordion-arrow" id="arrow-{{ item.date|date:'Y-m-d' }}">â–¼</span>
  </div>
  <div class="accordion-body" id="body-{{ item.date|date:'Y-m-d' }}">
    <table class="table-reservations">
      <thead>
        <tr>
          <th>RÃ©fÃ©rence</th>
          <th>Client</th>
          <th>Email</th>
          <th>Trajet</th>
          <th>DÃ©part</th>
          <th>Places</th>
          <th>Total</th>
          <th>Date rÃ©servation</th>
          <th>Moyen paiement</th>
          <th>Statut</th>
          <th>Billet</th>
        </tr>
      </thead>
      <tbody>
        {% for resa in item.reservations %}
        <tr>
          <td><code>{{ resa.reference }}</code></td>
          <td>
            <strong>{{ resa.utilisateur.get_full_name|default:resa.utilisateur.username }}</strong><br>
            <small>{{ resa.utilisateur.phone }}</small>
          </td>
          <td>{{ resa.utilisateur.email }}</td>
          <td>{{ resa.depart.trip.arret_depart.ville }} â†’ {{ resa.depart.trip.arret_arrivee.ville }}</td>
          <td>{{ resa.depart.heure_depart|time:"H:i" }} â†’ {{ resa.depart.heure_arrivee|time:"H:i" }}</td>
          <td>{{ resa.nombre_places }}</td>
          <td>{{ resa.prix_total }} FCFA</td>
          <td>{{ resa.created_at|date:"d/m/Y H:i" }}</td>
          <td>{% if resa.paiement %}{{ resa.paiement.moyen }}{% else %}â€”{% endif %}</td>
          <td>
            {% if resa.statut == 'CONFIRMEE' %}
              <span class="badge badge-vert">âœ… ConfirmÃ©e</span>
            {% elif resa.statut == 'EN_ATTENTE' %}
              <span class="badge badge-orange">â³ En attente</span>
            {% else %}
              <span class="badge badge-gris">â€”</span>
            {% endif %}
          </td>
          <td>
            {% if resa.statut == 'CONFIRMEE' %}
              <a href="{% url 'admin_voir_billet' resa.id %}" class="btn-sm btn-gris" target="_blank">ğŸ“„ Voir</a>
            {% else %}â€”{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% empty %}
<div class="empty-state">Aucune rÃ©servation pour le moment.</div>
{% endfor %}
<script>
function toggleAccordion(dateId) {
    const body  = document.getElementById('body-'  + dateId);
    const arrow = document.getElementById('arrow-' + dateId);
    const isOpen = body.style.display === 'block';
    body.style.display = isOpen ? 'none' : 'block';
    arrow.textContent  = isOpen ? 'â–¼' : 'â–²';
}
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    const bodyDuJour  = document.getElementById('body-'  + today);
    const arrowDuJour = document.getElementById('arrow-' + today);
    if (bodyDuJour) {
        bodyDuJour.style.display  = 'block';
        arrowDuJour.textContent   = 'â–²';
    }
});
</script>
{% endblock %}
